name: Build .NET Framework Project

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Restore NuGet packages
      run: nuget restore Loopback.csproj

    - name: Build Release
      run: msbuild Loopback.csproj /p:Configuration=Release /p:Platform=AnyCPU /p:DebugType=None /p:DebugSymbols=false /v:m

    - name: Prepare single-file EXE (no installer)
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        $exe = Join-Path $PWD 'bin\Release\WindowsLoopbackManager.exe'
        if (!(Test-Path $exe)) { throw "EXE not found: $exe" }
        New-Item -ItemType Directory -Force -Path 'dist\single' | Out-Null
        Copy-Item $exe 'dist\single\WindowsLoopbackManager.exe' -Force
        Get-FileHash 'dist\single\WindowsLoopbackManager.exe' -Algorithm SHA256 | Format-List

    - name: Install UPX
      run: choco install upx -y

    - name: Prepare UPX-compressed single-file EXE
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        New-Item -ItemType Directory -Force -Path 'dist\single-upx' | Out-Null
        Copy-Item 'dist\single\WindowsLoopbackManager.exe' 'dist\single-upx\WindowsLoopbackManager.exe' -Force
        
        $upxOk = $false
        
        & upx -6 --lzma 'dist\single-upx\WindowsLoopbackManager.exe'
        if ($LASTEXITCODE -eq 0) {
          $upxOk = $true
        }
        else {
          Write-Warning "UPX pack failed, retry with --force. ExitCode=$LASTEXITCODE"
          & upx -6 --lzma --force 'dist\single-upx\WindowsLoopbackManager.exe'
          if ($LASTEXITCODE -eq 0) {
            $upxOk = $true
          }
          else {
            Write-Warning "UPX pack failed even with --force. Skip UPX artifact. ExitCode=$LASTEXITCODE"
          }
        }
        
        if ($upxOk) {
          Get-FileHash 'dist\single-upx\WindowsLoopbackManager.exe' -Algorithm SHA256 | Format-List
        }
        else {
          Remove-Item 'dist\single-upx\WindowsLoopbackManager.exe' -Force -ErrorAction SilentlyContinue
        }
        
        exit 0

    - name: Upload Release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: WindowsLoopbackManager-Release
        path: bin\Release\

    - name: Upload single-file EXE
      uses: actions/upload-artifact@v4
      with:
        name: WindowsLoopbackManager-single-exe
        path: dist\single\WindowsLoopbackManager.exe

    - name: Upload UPX single-file EXE
      uses: actions/upload-artifact@v4
      if: ${{ hashFiles('dist/single-upx/WindowsLoopbackManager.exe') != '' }}
      with:
        name: WindowsLoopbackManager-single-exe-upx
        path: dist\single-upx\WindowsLoopbackManager.exe
